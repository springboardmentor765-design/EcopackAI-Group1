<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>EcoPackAI | Analytics Dashboard</title>
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Plotly.js -->
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <link rel="stylesheet" href="css/style.css">
</head>

<body>

    <!-- NAVBAR -->
    <nav class="navbar navbar-expand-lg fixed-top">
        <div class="container">
            <a class="navbar-brand" href="index.html"><i class="fas fa-leaf"></i> EcoPackAI</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"><a class="nav-link" href="index.html">Home</a></li>
                    <li class="nav-item"><a class="nav-link active" href="dashboard.html">Analytics Dashboard</a></li>
                    <li class="nav-item"><a class="nav-link" href="about.html">About</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="header text-center mt-5">
        <br>
        <h2><i class="fas fa-chart-line"></i> EcoPackAI Dashboard</h2>
        <p>Real-time Sustainability Insights</p>
    </div>

    <div class="container mt-4">

        <!-- KPI CARDS -->
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card score-card p-3 shadow-sm text-center">
                    <i class="fas fa-box-open fa-2x text-primary mb-2"></i>
                    <h6>Total Requests</h6>
                    <h3 id="totalRequests">Loading...</h3>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card score-card p-3 shadow-sm text-center">
                    <i class="fas fa-leaf fa-2x text-success mb-2"></i>
                    <h6>Avg. Sustainability Score</h6>
                    <h3 id="avgScore">Loading...</h3>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card score-card p-3 shadow-sm text-center">
                    <i class="fas fa-cloud fa-2x text-info mb-2"></i>
                    <h6>Est. CO₂ Savings (kg)</h6>
                    <h3 id="co2Savings">Loading...</h3>
                </div>
            </div>
        </div>

        <!-- CHARTS -->
        <!-- CHARTS -->
        <div class="row">
            <div class="col-md-4 mb-4">
                <div class="card shadow-sm p-3 h-100">
                    <h5 class="text-center text-success"><i class="fas fa-chart-pie"></i> Material Popularity (Top 5)
                    </h5>
                    <div id="materialChart" style="height: 300px;"></div>
                </div>
            </div>

            <div class="col-md-4 mb-4">
                <div class="card shadow-sm p-3 h-100">
                    <h5 class="text-center text-success"><i class="fas fa-chart-bar"></i> Requests by Category</h5>
                    <div id="categoryChart" style="height: 300px;"></div>
                </div>
            </div>

            <div class="col-md-4 mb-4">
                <div class="card shadow-sm p-3 h-100">
                    <h5 class="text-center text-success"><i class="fas fa-recycle"></i> Impact Overview</h5>
                    <div id="impactChart" style="height: 300px;"></div>
                </div>
            </div>
        </div>
        <div class="card shadow-sm mb-4">
            <div class="card-body">
                <h5 class="card-title text-success"><i class="fas fa-database"></i> Model Knowledge Base
                    (Capabilities)</h5>

                <!-- NEW: Visualization of Capabilities -->
                <div class="row mb-3">
                    <div class="col-md-12">
                        <div id="versatilityChart" style="height: 300px;"></div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <h6 class="text-secondary"><i class="fas fa-tags"></i> Supported Categories (Possible)</h6>
                        <div id="supportedCategories" class="d-flex flex-wrap gap-2">
                            <span class="spinner-border spinner-border-sm text-success"></span>
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <h6 class="text-secondary"><i class="fas fa-cubes"></i> Known Materials</h6>
                        <div id="knownMaterials" class="d-flex flex-wrap gap-2">
                            <span class="spinner-border spinner-border-sm text-success"></span>
                        </div>
                    </div>
                </div>
                <div class="alert alert-light border">
                    <h6><i class="fas fa-ruler-combined"></i> Valid Training Ranges (Scope)</h6>
                    <div id="validRanges" class="row text-center">
                        <div class="col"><small>Loading...</small></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="text-center mt-4 mb-5">
            <a href="index.html" class="btn btn-secondary"><i class="fas fa-arrow-left"></i> Back to
                Home</a>
            <a href="/export/pdf" class="btn btn-outline-danger"><i class="fas fa-file-pdf"></i>
                Export PDF</a>
            <a href="/export/excel" class="btn btn-outline-success"><i class="fas fa-file-excel"></i>
                Export Excel</a>
        </div>

    </div>

    <script>
        async function loadAnalytics() {
            try {
                const response = await fetch('/analytics');
                const data = await response.json();

                if (data.status === 'success') {
                    // Update KPIs
                    document.getElementById('totalRequests').innerText = data.total_requests;
                    document.getElementById('avgScore').innerText = data.avg_sustainability_score;
                    document.getElementById('co2Savings').innerText = data.estimated_co2_savings;

                    // Render Material Chart (Donut) - TOP 5 Only
                    const sortedMaterials = Object.entries(data.material_distribution)
                        .sort((a, b) => b[1] - a[1])
                        .slice(0, 5);

                    const materialData = [{
                        values: sortedMaterials.map(x => x[1]),
                        labels: sortedMaterials.map(x => x[0]),
                        type: 'pie',
                        hole: 0.4,
                        marker: {
                            colors: ['#2e7d32', '#66bb6a', '#a5d6a7', '#ffca28', '#ef5350']
                        }
                    }];

                    const materialLayout = {
                        height: 300,
                        margin: { t: 10, b: 10, l: 10, r: 10 },
                        showlegend: true,
                        legend: { orientation: 'h', y: -0.1 }
                    };

                    Plotly.newPlot('materialChart', materialData, materialLayout, { displayModeBar: false });

                    // Render Impact Trend Chart (Line)
                    const impactData = [{
                        x: data.impact_trends.labels,
                        y: data.impact_trends.data,
                        type: 'scatter',
                        mode: 'lines+markers',
                        name: 'Est. CO₂ Savings (kg)',
                        line: { color: '#2e7d32', width: 3 },
                        fill: 'tozeroy',
                        fillcolor: 'rgba(46, 125, 50, 0.1)'
                    }];

                    const impactLayout = {
                        height: 300,
                        margin: { t: 10, b: 30, l: 40, r: 10 },
                        xaxis: { title: 'Time' },
                        yaxis: { title: 'kg Saved' }
                    };



                    Plotly.newPlot('impactChart', impactData, impactLayout, { displayModeBar: false });

                    // --- NEW: Render Category Requests Chart (Bar) ---
                    if (data.category_requests) {
                        const sortedReqs = Object.entries(data.category_requests).sort((a, b) => b[1] - a[1]);
                        const crTrace = {
                            x: sortedReqs.map(x => x[0]),
                            y: sortedReqs.map(x => x[1]),
                            type: 'bar',
                            marker: { color: '#ffb74d' }
                        };
                        const crLayout = {
                            height: 300,
                            margin: { t: 10, b: 60, l: 40, r: 10 },
                            xaxis: { title: 'Category', tickangle: -45 },
                            yaxis: { title: 'Requests' }
                        };
                        Plotly.newPlot('categoryChart', [crTrace], crLayout, { displayModeBar: false });
                    }
                }
            } catch (error) {
                console.error("Error loading analytics:", error);
                alert("Failed to load dashboard data. Ensure backend is running.");
            }
        }

        loadAnalytics();

        async function loadCapabilities() {
            try {
                const response = await fetch('/api/dataset-info');
                const data = await response.json();

                if (data.status === 'success') {
                    // Render Categories (Detailed Display)
                    const catContainer = document.getElementById('supportedCategories');
                    // Use data.categories_display if available (from backend update)
                    const catsToShow = data.categories_display || data.categories;
                    catContainer.innerHTML = catsToShow.map(c =>
                        `<span class="badge bg-success bg-opacity-75">${c}</span>`
                    ).join(' ');

                    // Render Materials
                    const matContainer = document.getElementById('knownMaterials');
                    matContainer.innerHTML = data.materials.map(m =>
                        `<span class="badge bg-secondary">${m}</span>`
                    ).join(' ');

                    // Render Ranges
                    const rangeContainer = document.getElementById('validRanges');
                    rangeContainer.innerHTML = `
                        <div class="col-md-6">
                            <strong>Weight:</strong> ${data.ranges.weight_g.min}g - ${data.ranges.weight_g.max}g
                        </div>
                        <div class="col-md-6">
                            <strong>Price:</strong> ₹${data.ranges.price_inr.min} - ₹${data.ranges.price_inr.max}
                        </div>
                    `;

                    // --- NEW: Render Versatility Chart (Materials per Category) ---
                    if (data.materials_detailed) {
                        const catCounts = {};
                        data.categories.forEach(c => catCounts[c] = 0);

                        data.materials_detailed.forEach(mat => {
                            if (mat.suitable_for && mat.suitable_for.includes('All')) {
                                data.categories.forEach(c => catCounts[c]++);
                            } else if (mat.suitable_for) {
                                mat.suitable_for.forEach(cat => {
                                    if (catCounts[cat] !== undefined) catCounts[cat]++;
                                });
                            }
                        });

                        const sortedCats = Object.entries(catCounts).sort((a, b) => b[1] - a[1]);

                        const versTrace = {
                            x: sortedCats.map(x => x[0]),
                            y: sortedCats.map(x => x[1]),
                            type: 'bar',
                            marker: { color: 'rgba(54, 162, 235, 0.7)' }
                        };

                        const versLayout = {
                            title: 'Materials Available per Category',
                            xaxis: { title: 'Category', tickangle: -45 },
                            yaxis: { title: 'Count of Compatible Materials' },
                            margin: { b: 80 }
                        };

                        Plotly.newPlot('versatilityChart', [versTrace], versLayout, { displayModeBar: false });
                    }
                }
            } catch (error) {
                console.error("Error loading capabilities:", error);
                document.getElementById('supportedCategories').innerHTML = "<small class='text-danger'>Failed to load.</small>";
            }
        }

        loadCapabilities();
    </script>

    <!-- FOOTER -->
    <footer class="text-center">
        <div class="container">
            <p>&copy; 2026 EcoPackAI. All Rights Reserved.</p>
            <p class="small">Powered by AI &bull; Sustainable Future</p>
        </div>
    </footer>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>